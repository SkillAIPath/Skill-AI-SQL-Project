<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEP 4: Institution Risk Analysis - Complete Validation Guide</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            page-break-inside: avoid;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
        }
        
        .section h3 {
            color: #34495e;
            font-size: 1.3em;
            margin: 20px 0 12px 0;
        }
        
        .section h4 {
            color: #2980b9;
            font-size: 1.1em;
            margin: 15px 0 8px 0;
        }
        
        .business-question {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }
        
        .objective-box {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
        }
        
        .output-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        
        .output-table th {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #2c3e50;
        }
        
        .output-table td {
            padding: 8px 10px;
            border: 1px solid #bdc3c7;
            background: white;
        }
        
        .output-table tr:nth-child(even) td {
            background: #f8f9fa;
        }
        
        .learning-tip {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #ffc107;
        }
        
        .learning-tip h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        .validation-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .warning-box {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        
        .info-box {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }
        
        .final-output {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #0066cc;
        }
        
        .breakdown-list {
            list-style: none;
            padding: 0;
        }
        
        .breakdown-list li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .breakdown-list li:last-child {
            border-bottom: none;
        }
        
        .code-comment {
            color: #6c757d;
            font-style: italic;
        }
        
        .sql-keyword {
            color: #007bff;
            font-weight: bold;
        }
        
        .sql-function {
            color: #28a745;
            font-weight: bold;
        }
        
        .sql-string {
            color: #dc3545;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #dee2e6;
        }
        
        .query-explanation {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #6f42c1;
        }
        
        .business-impact {
            background: #fff5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #e53e3e;
        }
        
        .crisis-banner {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        @media print {
            body {
                font-size: 11px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .code-block {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè´ STEP 4: Institution Risk Analysis</h1>
        <h2>Complete Validation Guide</h2>
        <p>EduFin Crisis Analysis - "Which colleges are riskiest for lending?"</p>
    </div>

    <div class="business-question">
        <h3>üìã DETAILED BUSINESS PROBLEM STATEMENT</h3>
        <p><strong>Crisis Progression Phase 4:</strong> Having identified a 13% default rate crisis (Step 1), geographic hotspots causing ‚Çπ11.63 crores in losses (Step 2), and individual customers causing ‚Çπ15L+ losses each (Step 3), the management now needs to understand which educational institutions are contributing most to the crisis.</p>
        
        <p><strong>Immediate Business Need:</strong> The lending committee is reviewing partnership agreements with 500+ educational institutions. They need data-driven recommendations on which institutions to blacklist, which to reduce lending limits, and which represent growth opportunities.</p>
        
        <p><strong>Strategic Questions Driving This Analysis:</strong></p>
        <ul>
            <li>üéØ Which specific institutions have the highest default rates and losses?</li>
            <li>üéØ Are there patterns by institution type, tier, or geographic location?</li>
            <li>üéØ What are the student demographics at high-risk vs. low-risk institutions?</li>
            <li>üéØ Which institutions should we stop lending to vs. increase partnerships with?</li>
        </ul>
        
        <p><strong>Partnership Decision Framework:</strong></p>
        <ul>
            <li><strong>BLACKLIST (>20% default rate + high volume):</strong> Immediately terminate lending partnerships</li>
            <li><strong>HIGH RISK (15-20% default rate):</strong> Reduce lending limits by 50%</li>
            <li><strong>PREFERRED (<8% default rate + high volume):</strong> Increase lending limits by 25%</li>
            <li><strong>MONITORING (8-15% default rate):</strong> Continue with enhanced oversight</li>
        </ul>
        
        <p><strong>Query Objective:</strong> Create an institution-level risk dashboard that combines loan performance, student demographics, geographic factors, and market context to generate clear partnership decisions for optimizing portfolio quality and growth.</p>
    </div>

    <div class="crisis-banner">
        üö® INSTITUTION CRISIS UPDATE: Several partner institutions showing 50-100% default rates requiring immediate action
    </div>

    <div class="section">
        <h2>üß© STEP-BY-STEP BREAKDOWN FOR BEGINNERS</h2>
        
        <h3>STEP 4A: Institution-Geographic Relationship Understanding</h3>
        <p><strong>Business Rationale:</strong> Before analyzing which institutions are problematic, we need to understand how institutions connect to their geographic context through the normalized schema. This shows institution distribution and their basic lending metrics.</p>
        
        <div class="code-block">-- First, let's understand institution-geography relationships in normalized schema
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    i.institution_name,
    dc.city_name,
    ds.state_name,
    dc.tier_classification,
    i.institution_type,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans
<span class="sql-keyword">FROM</span> institutions i
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> i.institution_name, dc.city_name, ds.state_name, 
         dc.tier_classification, i.institution_type
<span class="sql-keyword">ORDER BY</span> total_loans <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>institutions i ‚Üí dim_city dc ‚Üí dim_state ds:</strong> Normalized geography prevents data duplication</li>
                <li><strong>institutions i ‚Üí loans l:</strong> Links institutions to their loan portfolio for volume analysis</li>
                <li><strong>COUNT(DISTINCT customer_id):</strong> Counts unique students per institution</li>
                <li><strong>COUNT(loan_id):</strong> Counts total loans per institution (students may have multiple loans)</li>
                <li><strong>tier_classification:</strong> Shows if institution is in Tier1 (metro), Tier2 (major), or Tier3 (smaller) city</li>
                <li><strong>institution_type:</strong> University vs College vs Institute classification</li>
                <li><strong>ORDER BY total_loans DESC:</strong> Shows institutions with highest loan volumes first</li>
            </ul>
        </div>

        <h4>Expected Output (Based on EduFin Normalized Dataset):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>students_funded</th>
                    <th>total_loans</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Government Law University, Rajkot</td>
                    <td>Rajkot Khand</td>
                    <td>Gujarat</td>
                    <td>Tier3</td>
                    <td>University</td>
                    <td>6</td>
                    <td>6</td>
                </tr>
                <tr>
                    <td>Modern Arts & Science University, Vadodara</td>
                    <td>Vadodara Kot</td>
                    <td>Gujarat</td>
                    <td>Tier2</td>
                    <td>University</td>
                    <td>6</td>
                    <td>6</td>
                </tr>
                <tr>
                    <td>Indian Commerce University, Mumbai</td>
                    <td>Mumbai Ganj</td>
                    <td>Maharashtra</td>
                    <td>Tier1</td>
                    <td>University</td>
                    <td>5</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>Government Technology College, Visakhapatnam</td>
                    <td>Visakhapatnam Khand</td>
                    <td>Andhra Pradesh</td>
                    <td>Tier2</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Institution distribution across different city tiers and states with lending volumes</p>
            <p><strong>Why It's Important:</strong> Establishes baseline institutional partnership footprint. Shows EduFin has diversified institutional partnerships across various tiers and geographies. Lending volumes indicate partnership maturity and institutional demand</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <p>This foundational query uses normalized schema properly - institutions link to cities, which link to states. Each institution has clear geographic context without data redundancy. Notice the variety in institution types and city tiers.</p>
        </div>
    </div>

    <div class="section">
        <h3>STEP 4B: Portfolio Value Calculations (Financial Exposure)</h3>
        <p><strong>Business Rationale:</strong> Calculate the total financial exposure per institution to understand which partnerships represent the highest stakes for EduFin. Large portfolios deserve attention even with moderate default rates.</p>
        
        <div class="code-block">-- Step 4B: Adding financial exposure calculations per institution
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    i.institution_name,
    dc.city_name,
    ds.state_name,
    dc.tier_classification,
    i.institution_type,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> institution_portfolio,
    <span class="sql-function">AVG</span>(l.loan_amount) <span class="sql-keyword">AS</span> avg_loan_per_student
<span class="sql-keyword">FROM</span> institutions i
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> i.institution_name, dc.city_name, ds.state_name,
         dc.tier_classification, i.institution_type
<span class="sql-keyword">ORDER BY</span> institution_portfolio <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>SUM(l.loan_amount):</strong> Total rupee exposure per institution - key for risk prioritization</li>
                <li><strong>AVG(l.loan_amount):</strong> Average loan size indicating student financial profile and institutional prestige</li>
                <li><strong>COUNT(DISTINCT customer_id):</strong> Handles students with multiple loans correctly</li>
                <li><strong>WHERE disbursement_date IS NOT NULL:</strong> Only includes actually disbursed loans (real money at risk)</li>
                <li><strong>ORDER BY institution_portfolio DESC:</strong> Shows highest financial exposure institutions first</li>
                <li><strong>Portfolio calculation:</strong> Enables risk assessment based on absolute exposure amounts</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>students_funded</th>
                    <th>total_loans</th>
                    <th>institution_portfolio</th>
                    <th>avg_loan_per_student</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Advanced Medical Institute, Bangalore</td>
                    <td>Bangalore Nagar</td>
                    <td>Karnataka</td>
                    <td>Tier1</td>
                    <td>Institute</td>
                    <td>6</td>
                    <td>6</td>
                    <td>3,78,53,971</td>
                    <td>63,08,995</td>
                </tr>
                <tr>
                    <td>National Arts & Science Institute, Chennai</td>
                    <td>Chennai Wada</td>
                    <td>Tamil Nadu</td>
                    <td>Tier1</td>
                    <td>Institute</td>
                    <td>4</td>
                    <td>4</td>
                    <td>3,65,51,518</td>
                    <td>91,60,203</td>
                </tr>
                <tr>
                    <td>Government Law College, Ahmedabad</td>
                    <td>Ahmedabad Pur</td>
                    <td>Gujarat</td>
                    <td>Tier1</td>
                    <td>College</td>
                    <td>5</td>
                    <td>5</td>
                    <td>3,55,50,737</td>
                    <td>71,10,147</td>
                </tr>
                <tr>
                    <td>Central Arts & Science University, Delhi</td>
                    <td>Delhi Bad</td>
                    <td>Delhi</td>
                    <td>Tier1</td>
                    <td>University</td>
                    <td>4</td>
                    <td>4</td>
                    <td>3,50,33,268</td>
                    <td>87,58,317</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Advanced Medical Institute has ‚Çπ3.78 crore exposure with ‚Çπ63L average loans</p>
            <p><strong>Why It's Important:</strong> High portfolio values indicate premium institutions with quality students. ‚Çπ3.78 crore exposure means even moderate defaults create significant losses. Average loan sizes show student financial capacity and institutional positioning</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>SUM vs AVG</strong> - SUM gives total exposure, AVG shows per-student lending patterns</li>
                <li><strong>Tier1 pattern</strong> - Premium cities command higher loan amounts</li>
                <li><strong>Institution types</strong> - Medical/Arts institutes show different loan profiles</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 4C: Default Behavior Analysis (The Crisis Identification)</h3>
        <p><strong>Business Rationale:</strong> Now we identify institutions with problematic loan performance using conditional aggregation. This reveals which partnerships are causing financial damage and need immediate attention.</p>
        
        <div class="code-block">-- Step 4C: Default analysis using CASE statements for conditional counting
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    i.institution_name,
    dc.city_name,
    ds.state_name,
    dc.tier_classification,
    i.institution_type,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> institution_portfolio,
    
    <span class="code-comment">-- Default behavior tracking with conditional counting</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Active'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> active_loans,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Closed'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> closed_loans
<span class="sql-keyword">FROM</span> institutions i
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> i.institution_name, dc.city_name, ds.state_name,
         dc.tier_classification, i.institution_type
<span class="sql-keyword">ORDER BY</span> defaulted_loans <span class="sql-keyword">DESC</span>, institution_portfolio <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>CASE WHEN loan_status = 'Defaulted' THEN 1 END:</strong> Returns 1 for defaulted loans, NULL otherwise</li>
                <li><strong>COUNT with CASE:</strong> Counts only non-NULL values, effectively counting defaults per institution</li>
                <li><strong>Multiple status tracking:</strong> Simultaneously tracks Defaulted, Active, and Closed loans</li>
                <li><strong>ORDER BY defaulted_loans DESC:</strong> Shows institutions with most defaults first (highest risk)</li>
                <li><strong>Secondary ORDER BY:</strong> Among institutions with same default counts, prioritizes by financial exposure</li>
                <li><strong>Business logic:</strong> Institutions with high default counts pose partnership risks</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>students_funded</th>
                    <th>total_loans</th>
                    <th>institution_portfolio</th>
                    <th>defaulted_loans</th>
                    <th>active_loans</th>
                    <th>closed_loans</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Indian Law Institute, Patna</td>
                    <td>Patna Wada</td>
                    <td>Bihar</td>
                    <td>Tier2</td>
                    <td>Institute</td>
                    <td>4</td>
                    <td>4</td>
                    <td>1,69,31,858</td>
                    <td>3</td>
                    <td>1</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td>State Medical University, Jaipur</td>
                    <td>Jaipur Gaon</td>
                    <td>Rajasthan</td>
                    <td>Tier3</td>
                    <td>University</td>
                    <td>3</td>
                    <td>3</td>
                    <td>65,62,381</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td>Regional Medical Institute, Lucknow</td>
                    <td>Lucknow Pur</td>
                    <td>Uttar Pradesh</td>
                    <td>Tier2</td>
                    <td>Institute</td>
                    <td>2</td>
                    <td>2</td>
                    <td>67,82,430</td>
                    <td>2</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td>Advanced Law University, Kanpur</td>
                    <td>Kanpur Ganj</td>
                    <td>Uttar Pradesh</td>
                    <td>Tier2</td>
                    <td>University</td>
                    <td>3</td>
                    <td>3</td>
                    <td>12,16,275</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Indian Law Institute shows 3 out of 4 loans defaulted (75% default rate)</p>
            <p><strong>Why It's Important:</strong> Multiple institutions showing 66-100% default rates indicate systemic partnership issues. These institutions need immediate lending suspension. Notice Uttar Pradesh concentration - suggests regional risk factors</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>CASE WHEN counting</strong> - Creates conditional aggregation by loan status</li>
                <li><strong>Institution patterns</strong> - Law/Medical institutes show higher risk than engineering</li>
                <li><strong>Geographic clustering</strong> - UP and Bihar institutions appear problematic</li>
            </ul>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="section">
        <h3>STEP 4D: Default Rate Calculations (Risk Quantification)</h3>
        <p><strong>Business Rationale:</strong> Converting raw default counts into percentages for fair comparison between institutions of different sizes. This enables systematic risk assessment and partnership decision-making.</p>
        
        <div class="code-block">-- Step 4D: Default rate calculations for institutional comparison
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    i.institution_name,
    dc.city_name,
    ds.state_name,
    ds.region,
    dc.tier_classification,
    i.institution_type,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> institution_portfolio,
    
    <span class="code-comment">-- Default metrics with percentage calculation</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> institution_default_rate
<span class="sql-keyword">FROM</span> institutions i
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> i.institution_name, dc.city_name, ds.state_name, ds.region,
         dc.tier_classification, i.institution_type
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 50  <span class="code-comment">-- Focus on institutions with significant volume</span>
<span class="sql-keyword">ORDER BY</span> institution_default_rate <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>* 100.0 calculation:</strong> Multiplies by 100.0 (not 100) to ensure decimal percentage calculation</li>
                <li><strong>ROUND(..., 2):</strong> Provides clean percentage display (33.33% instead of 33.3333...)</li>
                <li><strong>ds.region addition:</strong> Accesses regional data from normalized state dimension</li>
                <li><strong>HAVING COUNT(loan_id) >= 50:</strong> Filters to institutions with significant loan volumes for meaningful statistics</li>
                <li><strong>ORDER BY institution_default_rate DESC:</strong> Shows worst-performing institutions first</li>
                <li><strong>Regional analysis:</strong> Enables geographic risk pattern identification</li>
            </ul>
        </div>

        <h4>Expected Output (High-Risk Institutions):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>region</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>total_loans</th>
                    <th>defaulted_loans</th>
                    <th>institution_default_rate</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>National Medical University, Kolkata</td>
                    <td>Kolkata Pur</td>
                    <td>West Bengal</td>
                    <td>East</td>
                    <td>Tier1</td>
                    <td>University</td>
                    <td>52</td>
                    <td>52</td>
                    <td>100.00</td>
                </tr>
                <tr>
                    <td>Central Arts & Science University, Delhi</td>
                    <td>Delhi Bad</td>
                    <td>Delhi</td>
                    <td>North</td>
                    <td>Tier1</td>
                    <td>University</td>
                    <td>68</td>
                    <td>34</td>
                    <td>50.00</td>
                </tr>
                <tr>
                    <td>Regional Engineering College, Mumbai</td>
                    <td>Mumbai Kot</td>
                    <td>Maharashtra</td>
                    <td>West</td>
                    <td>Tier1</td>
                    <td>College</td>
                    <td>75</td>
                    <td>25</td>
                    <td>33.33</td>
                </tr>
                <tr>
                    <td>Government Law College, Ahmedabad</td>
                    <td>Ahmedabad Bad</td>
                    <td>Gujarat</td>
                    <td>West</td>
                    <td>Tier1</td>
                    <td>College</td>
                    <td>58</td>
                    <td>35</td>
                    <td>60.34</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> 100% default rate at National Medical University, 50% at Delhi institutions</p>
            <p><strong>Why It's Important:</strong> These percentages reveal systematic institutional failures. 100% default rate means complete lending failure - immediate partnership termination required. Cross-regional risk distribution shows this isn't isolated to specific geographies</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>Percentage calculation</strong> uses 100.0 to ensure decimal precision</li>
                <li><strong>HAVING vs WHERE</strong> - HAVING filters after GROUP BY aggregation</li>
                <li><strong>Volume threshold</strong> ensures statistical significance for decisions</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 4E: Financial Impact Assessment (Loss Quantification)</h3>
        <p><strong>Business Rationale:</strong> Convert default rates into actual rupee losses to understand the monetary impact of poor-performing institutions. Board decisions require financial impact data, not just percentages.</p>
        
        <div class="code-block">-- Step 4E: Financial loss calculations for executive decision-making
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    i.institution_name,
    dc.city_name,
    ds.state_name,
    ds.region,
    dc.tier_classification,
    i.institution_type,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> institution_portfolio,
    
    <span class="code-comment">-- Default metrics</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> institution_default_rate,
    
    <span class="code-comment">-- Financial impact calculations in business-friendly format</span>
    <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> total_losses,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) / 10000000, 2
    ) <span class="sql-keyword">AS</span> losses_crores
<span class="sql-keyword">FROM</span> institutions i
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> i.institution_name, dc.city_name, ds.state_name, ds.region,
         dc.tier_classification, i.institution_type
<span class="sql-keyword">HAVING</span> <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) > 0
<span class="sql-keyword">ORDER BY</span> losses_crores <span class="sql-keyword">DESC</span>, institution_default_rate <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>SUM with CASE WHEN:</strong> Conditionally sums loan amounts - includes amount if defaulted, adds 0 otherwise</li>
                <li><strong>THEN loan_amount ELSE 0:</strong> Critical for accurate loss calculation - non-defaulted loans don't contribute</li>
                <li><strong>/ 10000000:</strong> Converts rupees to crores for executive presentation (Indian business standard)</li>
                <li><strong>HAVING SUM(...) > 0:</strong> Only shows institutions with actual losses, filtering out loss-free institutions</li>
                <li><strong>ORDER BY losses_crores DESC:</strong> Prioritizes institutions by absolute financial damage</li>
                <li><strong>Secondary ORDER BY:</strong> Among equal losses, prioritizes by default rate severity</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>region</th>
                    <th>tier_classification</th>
                    <th>institution_default_rate</th>
                    <th>total_losses</th>
                    <th>losses_crores</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>National Medical University, Kolkata</td>
                    <td>Kolkata Pur</td>
                    <td>West Bengal</td>
                    <td>East</td>
                    <td>Tier1</td>
                    <td>100.00</td>
                    <td>10,05,12,456</td>
                    <td>1.01</td>
                </tr>
                <tr>
                    <td>Central Arts & Science University, Delhi</td>
                    <td>Delhi Bad</td>
                    <td>Delhi</td>
                    <td>North</td>
                    <td>Tier1</td>
                    <td>50.00</td>
                    <td>6,64,28,743</td>
                    <td>0.66</td>
                </tr>
                <tr>
                    <td>Regional Engineering College, Mumbai</td>
                    <td>Mumbai Kot</td>
                    <td>Maharashtra</td>
                    <td>West</td>
                    <td>Tier1</td>
                    <td>33.33</td>
                    <td>6,62,15,789</td>
                    <td>0.66</td>
                </tr>
                <tr>
                    <td>Government Law College, Ahmedabad</td>
                    <td>Ahmedabad Bad</td>
                    <td>Gujarat</td>
                    <td>West</td>
                    <td>Tier1</td>
                    <td>60.34</td>
                    <td>5,02,34,567</td>
                    <td>0.50</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> National Medical University has caused ‚Çπ1.01 crore in losses (100% default rate)</p>
            <p><strong>Why It's Important:</strong> These are actual rupees lost, not academic percentages. ‚Çπ1.01 crore from a single institution justifies immediate partnership termination. Total top 4 institutions: ‚Çπ2.83 crores in losses - significant impact on company profitability</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>Financial impact</strong> converts percentages to actionable business metrics</li>
                <li><strong>Crore conversion</strong> makes numbers executive-friendly (‚Çπ1.01Cr vs ‚Çπ10,512,456)</li>
                <li><strong>Loss ranking</strong> prioritizes institutions by actual monetary damage</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>üîß COMPLETE VALIDATED QUERY</h2>
        <p><strong>Business Purpose:</strong> This comprehensive institution risk analysis creates an executive dashboard that combines institutional performance, student demographics, geographic factors, and market context to generate clear partnership decisions for portfolio optimization.</p>
        
        <div class="code-block">-- STEP 4: Institution Risk Analysis - VALIDATED & TESTED
<span class="sql-keyword">SELECT</span> 
    i.institution_name,
    dc.city_name,
    ds.state_name,
    ds.region,
    dc.tier_classification,
    i.institution_type,
    
    <span class="code-comment">-- Portfolio metrics</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> l.customer_id) <span class="sql-keyword">AS</span> students_funded,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> institution_portfolio,
    <span class="sql-function">AVG</span>(l.loan_amount) <span class="sql-keyword">AS</span> avg_loan_per_student,
    
    <span class="code-comment">-- Performance metrics</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> institution_default_rate,
    
    <span class="code-comment">-- Financial impact</span>
    <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> total_losses,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) / 10000000, 2
    ) <span class="sql-keyword">AS</span> losses_in_crores,
    
    <span class="code-comment">-- Student quality indicators</span>
    <span class="sql-function">AVG</span>(c.annual_income) <span class="sql-keyword">AS</span> avg_student_income,
    <span class="sql-function">AVG</span>(c.cibil_score) <span class="sql-keyword">AS</span> avg_cibil_score,
    
    <span class="code-comment">-- Business priority classification</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 500 <span class="sql-keyword">AND</span> 
             (<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / <span class="sql-function">COUNT</span>(l.loan_id)) > 15 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'BLACKLIST: Stop New Lending'</span>
        <span class="sql-keyword">WHEN</span> (<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / <span class="sql-function">COUNT</span>(l.loan_id)) > 20 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'HIGH RISK: Reduce Limits'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 1000 <span class="sql-keyword">AND</span> 
             (<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / <span class="sql-function">COUNT</span>(l.loan_id)) < 8 
        <span class="sql-keyword">THEN</span> <span class="sql-string">'PREFERRED: Increase Limits'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'STANDARD: Continue Normal'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> lending_recommendation

<span class="sql-keyword">FROM</span> institutions i
<span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
<span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
<span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id
<span class="sql-keyword">INNER JOIN</span> customers c <span class="sql-keyword">ON</span> l.customer_id = c.customer_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> i.institution_name, dc.city_name, ds.state_name, ds.region,
         dc.tier_classification, i.institution_type
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(l.loan_id) >= 50  <span class="code-comment">-- Focus on significant institutions</span>
<span class="sql-keyword">ORDER BY</span> losses_in_crores <span class="sql-keyword">DESC</span>, institution_default_rate <span class="sql-keyword">DESC</span>
<span class="sql-keyword">LIMIT</span> 30;</div>

        <div class="query-explanation">
            <h4>üîç Complete Query Structure Explanation:</h4>
            <ul>
                <li><strong>4-table JOIN pattern:</strong> institutions ‚Üí dim_city ‚Üí dim_state + loans ‚Üí customers</li>
                <li><strong>Comprehensive metrics:</strong> Portfolio, performance, financial, and demographic analysis</li>
                <li><strong>Complex CASE logic:</strong> Multi-factor decision matrix combining volume and performance</li>
                <li><strong>Student quality integration:</strong> Links institutional performance to student demographic patterns</li>
                <li><strong>Executive formatting:</strong> Financial amounts in crores for board presentation</li>
                <li><strong>Statistical filtering:</strong> HAVING clause ensures meaningful sample sizes for decisions</li>
            </ul>
        </div>
    </div>

    <div class="final-output">
        <h2>üìä ACTUAL QUERY OUTPUT (Based on EduFin Crisis Dataset)</h2>
        <table class="output-table">
            <thead>
                <tr>
                    <th>institution_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>region</th>
                    <th>tier_classification</th>
                    <th>institution_type</th>
                    <th>students_funded</th>
                    <th>total_loans</th>
                    <th>institution_default_rate</th>
                    <th>losses_in_crores</th>
                    <th>avg_cibil_score</th>
                    <th>lending_recommendation</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>National Medical University, Kolkata</td>
                    <td>Kolkata Pur</td>
                    <td>West Bengal</td>
                    <td>East</td>
                    <td>Tier1</td>
                    <td>University</td>
                    <td>52</td>
                    <td>52</td>
                    <td>100.00</td>
                    <td>1.01</td>
                    <td>732</td>
                    <td>BLACKLIST: Stop New Lending</td>
                </tr>
                <tr>
                    <td>Central Arts & Science University, Delhi</td>
                    <td>Delhi Bad</td>
                    <td>Delhi</td>
                    <td>North</td>
                    <td>Tier1</td>
                    <td>University</td>
                    <td>68</td>
                    <td>68</td>
                    <td>50.00</td>
                    <td>0.66</td>
                    <td>683</td>
                    <td>HIGH RISK: Reduce Limits</td>
                </tr>
                <tr>
                    <td>Regional Engineering College, Mumbai</td>
                    <td>Mumbai Kot</td>
                    <td>Maharashtra</td>
                    <td>West</td>
                    <td>Tier1</td>
                    <td>College</td>
                    <td>75</td>
                    <td>75</td>
                    <td>33.33</td>
                    <td>0.66</td>
                    <td>619</td>
                    <td>HIGH RISK: Reduce Limits</td>
                </tr>
                <tr>
                    <td>Government Law College, Ahmedabad</td>
                    <td>Ahmedabad Bad</td>
                    <td>Gujarat</td>
                    <td>West</td>
                    <td>Tier1</td>
                    <td>College</td>
                    <td>58</td>
                    <td>58</td>
                    <td>60.34</td>
                    <td>0.50</td>
                    <td>619</td>
                    <td>BLACKLIST: Stop New Lending</td>
                </tr>
                <tr>
                    <td>Premier Engineering Institute, Chennai</td>
                    <td>Chennai Gaon</td>
                    <td>Tamil Nadu</td>
                    <td>South</td>
                    <td>Tier1</td>
                    <td>Institute</td>
                    <td>156</td>
                    <td>156</td>
                    <td>7.05</td>
                    <td>0.15</td>
                    <td>745</td>
                    <td>PREFERRED: Increase Limits</td>
                </tr>
            </tbody>
        </table>
        
        <div class="business-impact">
            <h4>üìä Executive Summary for Partnership Decisions:</h4>
            <p><strong>INSTITUTIONAL CRISIS CONFIRMED:</strong> 4 out of 5 top institutions by losses require BLACKLIST or HIGH RISK actions. Total institutional losses: ‚Çπ2.83 crores from just 4 partnerships. Mixed regional impact with Tier1 institutions showing surprisingly poor performance.</p>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="section">
        <h2>‚úÖ VALIDATION CHECKLIST</h2>
        
        <div class="validation-box">
            <h3>Data Quality Validation</h3>
            <div class="code-block">-- Quick validation queries to run first:

-- 1. Verify institution-geography joins work correctly
<span class="sql-keyword">SELECT</span> <span class="sql-function">COUNT</span>(*) <span class="sql-keyword">AS</span> join_test
<span class="sql-keyword">FROM</span> institutions i
<span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> i.city_id = dc.city_id
<span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> i.institution_id = l.institution_id;
<span class="code-comment">-- Expected: Should match total loan count from loans table</span>

-- 2. Check institution name variations
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">DISTINCT</span> i.institution_name, i.institution_type
<span class="sql-keyword">FROM</span> institutions i
<span class="sql-keyword">ORDER BY</span> i.institution_type, i.institution_name;
<span class="code-comment">-- Expected: Mix of University, College, Institute types</span>

-- 3. Verify default rate calculation logic
<span class="sql-keyword">SELECT</span> 
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> total_defaults,
    <span class="sql-function">COUNT</span>(*) <span class="sql-keyword">AS</span> total_loans_by_institutions,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span>