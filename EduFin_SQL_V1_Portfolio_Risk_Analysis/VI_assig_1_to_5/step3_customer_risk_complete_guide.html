<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEP 3: Customer Risk Segmentation - Complete Validation Guide</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            page-break-inside: avoid;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
        }
        
        .section h3 {
            color: #34495e;
            font-size: 1.3em;
            margin: 20px 0 12px 0;
        }
        
        .section h4 {
            color: #2980b9;
            font-size: 1.1em;
            margin: 15px 0 8px 0;
        }
        
        .business-question {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }
        
        .objective-box {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
        }
        
        .output-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        
        .output-table th {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #2c3e50;
        }
        
        .output-table td {
            padding: 8px 10px;
            border: 1px solid #bdc3c7;
            background: white;
        }
        
        .output-table tr:nth-child(even) td {
            background: #f8f9fa;
        }
        
        .learning-tip {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #ffc107;
        }
        
        .learning-tip h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        .validation-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .warning-box {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        
        .info-box {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }
        
        .final-output {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #0066cc;
        }
        
        .breakdown-list {
            list-style: none;
            padding: 0;
        }
        
        .breakdown-list li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .breakdown-list li:last-child {
            border-bottom: none;
        }
        
        .code-comment {
            color: #6c757d;
            font-style: italic;
        }
        
        .sql-keyword {
            color: #007bff;
            font-weight: bold;
        }
        
        .sql-function {
            color: #28a745;
            font-weight: bold;
        }
        
        .sql-string {
            color: #dc3545;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #dee2e6;
        }
        
        .query-explanation {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #6f42c1;
        }
        
        .business-impact {
            background: #fff5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #e53e3e;
        }
        
        .crisis-banner {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        @media print {
            body {
                font-size: 11px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .code-block {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎯 STEP 3: Customer Risk Segmentation</h1>
        <h2>Complete Validation Guide</h2>
        <p>EduFin Crisis Analysis - "Who are our highest risk customers?"</p>
    </div>

    <div class="business-question">
        <h3>📋 DETAILED BUSINESS PROBLEM STATEMENT</h3>
        <p><strong>Crisis Escalation Phase 3:</strong> After confirming a 13% portfolio default rate (Step 1) and identifying geographic crisis hotspots causing ₹11.63 crores in losses (Step 2), the CEO now needs to identify the specific individual customers causing maximum financial damage for immediate intervention.</p>
        
        <p><strong>Immediate Business Need:</strong> The collections department has limited resources - only 3 senior legal officers and 12 field collection agents. They need a prioritized list of customers based on risk severity, contact information, and recommended actions to maximize recovery efforts in the next 30 days.</p>
        
        <p><strong>Executive Questions Driving This Analysis:</strong></p>
        <ul>
            <li>🎯 Which specific customers have multiple defaults and highest financial impact?</li>
            <li>🎯 What are their contact details for immediate legal/collection action?</li>
            <li>🎯 Which customers need legal action vs. aggressive collection vs. loan restructuring?</li>
            <li>🎯 Are there patterns in customer demographics that predict default behavior?</li>
        </ul>
        
        <p><strong>Resource Allocation Decision Framework:</strong></p>
        <ul>
            <li><strong>EXTREME RISK (2+ defaults + ₹5L+ exposure):</strong> IMMEDIATE LEGAL ACTION - Deploy senior legal officers</li>
            <li><strong>HIGH RISK (1 default + ₹3L+ exposure + CIBIL<650):</strong> AGGRESSIVE COLLECTION - Deploy experienced agents</li>
            <li><strong>CREDIT RISK (CIBIL<650 + multiple loans):</strong> RESTRUCTURE LOANS - Financial counseling approach</li>
            <li><strong>HIGH EXPOSURE (₹10L+ total exposure):</strong> PREVENTIVE MONITORING - Protect large portfolios</li>
        </ul>
        
        <p><strong>Query Objective:</strong> Create a customer-level risk dashboard with demographics, financial exposure, default patterns, and contact information to enable immediate targeted collection and legal actions for maximum recovery impact.</p>
    </div>

    <div class="crisis-banner">
        🚨 CUSTOMER CRISIS UPDATE: Individual customer analysis reveals repeat defaulters causing ₹15L+ losses per customer
    </div>

    <div class="section">
        <h2>🧩 STEP-BY-STEP BREAKDOWN FOR BEGINNERS</h2>
        
        <h3>STEP 3A: Basic Customer-Loan Relationship Understanding</h3>
        <p><strong>Business Rationale:</strong> Before analyzing customer risk, we need to establish the foundation by understanding how customers link to their loan portfolios through the normalized schema. This shows customer demographics with their total loan exposure.</p>
        
        <div class="code-block">-- First, let's understand customer-loan relationships with geographic context
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    c.customer_id,
    c.full_name,
    dc.city_name,
    ds.state_name,
    c.annual_income,
    c.cibil_score,
    c.employment_type,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> total_exposure
<span class="sql-keyword">FROM</span> customers c
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> c.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> c.customer_id = l.customer_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> c.customer_id, c.full_name, dc.city_name, ds.state_name, 
         c.annual_income, c.cibil_score, c.employment_type
<span class="sql-keyword">ORDER BY</span> total_exposure <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>🔍 Detailed Query Explanation:</h4>
            <ul>
                <li><strong>customers c → dim_city dc → dim_state ds:</strong> Normalized geographic joins prevent data duplication</li>
                <li><strong>customers c → loans l:</strong> Links customers to their loan portfolio for exposure calculation</li>
                <li><strong>COUNT(l.loan_id):</strong> Counts total loans per customer to identify multiple loan holders</li>
                <li><strong>SUM(l.loan_amount):</strong> Calculates total financial exposure per customer for risk assessment</li>
                <li><strong>WHERE disbursement_date IS NOT NULL:</strong> Only includes actually disbursed loans (real financial risk)</li>
                <li><strong>GROUP BY customer details:</strong> Aggregates all loans per customer while preserving demographics</li>
                <li><strong>ORDER BY total_exposure DESC:</strong> Shows highest financial exposure customers first</li>
            </ul>
        </div>

        <h4>Expected Output (Based on EduFin Crisis Dataset):</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>customer_id</th>
                    <th>full_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>annual_income</th>
                    <th>cibil_score</th>
                    <th>employment_type</th>
                    <th>total_loans</th>
                    <th>total_exposure</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2479</td>
                    <td>Upasna Pal</td>
                    <td>Patna Khand</td>
                    <td>Bihar</td>
                    <td>943,816</td>
                    <td>615</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>21,81,772</td>
                </tr>
                <tr>
                    <td>4142</td>
                    <td>Hemani Dey</td>
                    <td>Jaipur Nagar</td>
                    <td>Rajasthan</td>
                    <td>12,62,472</td>
                    <td>761</td>
                    <td>Business Owner</td>
                    <td>3</td>
                    <td>21,62,456</td>
                </tr>
                <tr>
                    <td>1755</td>
                    <td>Harsh Baria</td>
                    <td>Chennai Wada</td>
                    <td>Tamil Nadu</td>
                    <td>897,882</td>
                    <td>772</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>21,39,354</td>
                </tr>
                <tr>
                    <td>3662</td>
                    <td>Abha Kent</td>
                    <td>Nagpur Khand</td>
                    <td>Maharashtra</td>
                    <td>660,375</td>
                    <td>781</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>21,26,520</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>📊 What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Customers with highest financial exposure, showing demographic patterns and portfolio concentration</p>
            <p><strong>Why It's Important:</strong> Upasna Pal has ₹21.8L exposure with a moderate CIBIL score (615) - this profile needs monitoring. High-exposure customers deserve attention even without current defaults to prevent future losses</p>
        </div>

        <div class="learning-tip">
            <h4>✅ Beginner Learning:</h4>
            <p>This foundational query establishes customer-centric analysis. Notice how we join through normalized dimensions first, then aggregate loan data. The high exposure amounts (₹20L+) indicate quality customers whose defaults would cause significant losses.</p>
        </div>
    </div>

    <div class="section">
        <h3>STEP 3B: Default Behavior Tracking (The Risk Identification)</h3>
        <p><strong>Business Rationale:</strong> Now we add conditional counting to identify customers with multiple defaults - the most dangerous category. Multiple defaulters show behavioral patterns that indicate they're unlikely to recover without legal intervention.</p>
        
        <div class="code-block">-- Step 3B: Adding default behavior analysis using CASE statements
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    c.customer_id,
    c.full_name,
    dc.city_name,
    c.annual_income,
    c.cibil_score,
    c.employment_type,
    
    <span class="code-comment">-- Portfolio metrics</span>
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> total_exposure,
    
    <span class="code-comment">-- Default behavior tracking with conditional counting</span>
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Active'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> active_loans,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Overdue'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> overdue_loans
<span class="sql-keyword">FROM</span> customers c
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> c.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> c.customer_id = l.customer_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> c.customer_id, c.full_name, dc.city_name, c.annual_income, c.cibil_score, c.employment_type
<span class="sql-keyword">ORDER BY</span> defaulted_loans <span class="sql-keyword">DESC</span>, total_exposure <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>🔍 Detailed Query Explanation:</h4>
            <ul>
                <li><strong>CASE WHEN loan_status = 'Defaulted' THEN 1 END:</strong> Returns 1 for defaulted loans, NULL otherwise</li>
                <li><strong>COUNT with CASE:</strong> Counts only non-NULL values, effectively counting defaulted loans per customer</li>
                <li><strong>Multiple status tracking:</strong> Simultaneously counts Defaulted, Active, and Overdue loans per customer</li>
                <li><strong>ORDER BY defaulted_loans DESC:</strong> Prioritizes customers with most defaults (highest risk)</li>
                <li><strong>Secondary ORDER BY total_exposure:</strong> Among customers with same default count, prioritizes by financial impact</li>
                <li><strong>Risk logic:</strong> Customers with 2+ defaults are exponentially more dangerous than single defaulters</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>customer_id</th>
                    <th>full_name</th>
                    <th>city_name</th>
                    <th>annual_income</th>
                    <th>cibil_score</th>
                    <th>employment_type</th>
                    <th>total_loans</th>
                    <th>total_exposure</th>
                    <th>defaulted_loans</th>
                    <th>active_loans</th>
                    <th>overdue_loans</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1047</td>
                    <td>Raghav Dubey</td>
                    <td>Guwahati Wada</td>
                    <td>225,532</td>
                    <td>486</td>
                    <td>Self Employed</td>
                    <td>3</td>
                    <td>15,06,980</td>
                    <td>3</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td>4230</td>
                    <td>Pankaj Ghokar</td>
                    <td>Nashik Wada</td>
                    <td>579,592</td>
                    <td>637</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>10,32,812</td>
                    <td>3</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td>4724</td>
                    <td>Ishan Joshi</td>
                    <td>Kanpur Bad</td>
                    <td>11,33,345</td>
                    <td>583</td>
                    <td>Self Employed</td>
                    <td>3</td>
                    <td>9,68,309</td>
                    <td>3</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
                <tr>
                    <td>3728</td>
                    <td>Jai Tailor</td>
                    <td>Coimbatore Kot</td>
                    <td>417,190</td>
                    <td>582</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>15,44,170</td>
                    <td>2</td>
                    <td>1</td>
                    <td>0</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>📊 What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Raghav Dubey has defaulted on ALL 3 loans (100% default rate) with ₹15.07L exposure</p>
            <p><strong>Why It's Important:</strong> Customers with 3/3 defaults show complete payment failure patterns. These are not temporary financial difficulties - these are behavioral defaults requiring immediate legal action. Notice the low CIBIL scores (486-583) validating credit risk assessment</p>
        </div>

        <div class="learning-tip">
            <h4>✅ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>CASE WHEN ... THEN 1 END</strong> creates conditional counting per customer</li>
                <li><strong>Multiple defaults = exponential risk</strong> - 3/3 defaults much worse than 1/3</li>
                <li><strong>Self-employed pattern emerging</strong> - higher default rates in this category</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 3C: Risk Percentage Calculations (Quantifying the Crisis)</h3>
        <p><strong>Business Rationale:</strong> Converting raw default counts into percentages and actual loss amounts to quantify the severity of each customer's risk profile. This enables comparative risk assessment and financial impact prioritization.</p>
        
        <div class="code-block">-- Step 3C: Risk rate calculations and financial loss quantification
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    c.customer_id,
    c.full_name,
    dc.city_name,
    c.annual_income,
    c.cibil_score,
    c.employment_type,
    
    <span class="code-comment">-- Portfolio metrics</span>
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> total_exposure,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    
    <span class="code-comment">-- Risk percentage calculation</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> personal_default_rate,
    
    <span class="code-comment">-- Financial loss calculation</span>
    <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> loss_amount
<span class="sql-keyword">FROM</span> customers c
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> c.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> c.customer_id = l.customer_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> c.customer_id, c.full_name, dc.city_name, c.annual_income, c.cibil_score, c.employment_type
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) > 0
<span class="sql-keyword">ORDER BY</span> loss_amount <span class="sql-keyword">DESC</span>, personal_default_rate <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>🔍 Detailed Query Explanation:</h4>
            <ul>
                <li><strong>* 100.0 calculation:</strong> Multiplies by 100.0 (not 100) to ensure decimal percentage calculation</li>
                <li><strong>ROUND(..., 2):</strong> Provides clean percentage display (66.67% instead of 66.6666...)</li>
                <li><strong>SUM with CASE for losses:</strong> Conditionally sums only defaulted loan amounts for actual loss calculation</li>
                <li><strong>HAVING clause:</strong> Filters to only customers with at least one default (problem customers only)</li>
                <li><strong>ORDER BY loss_amount DESC:</strong> Prioritizes by actual financial damage for maximum recovery impact</li>
                <li><strong>Secondary ORDER BY:</strong> Among equal losses, prioritizes by highest default rate (behavioral risk)</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>customer_id</th>
                    <th>full_name</th>
                    <th>city_name</th>
                    <th>annual_income</th>
                    <th>cibil_score</th>
                    <th>employment_type</th>
                    <th>total_loans</th>
                    <th>total_exposure</th>
                    <th>defaulted_loans</th>
                    <th>personal_default_rate</th>
                    <th>loss_amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1047</td>
                    <td>Raghav Dubey</td>
                    <td>Guwahati Wada</td>
                    <td>225,532</td>
                    <td>486</td>
                    <td>Self Employed</td>
                    <td>3</td>
                    <td>15,06,980</td>
                    <td>3</td>
                    <td>100.00</td>
                    <td>15,06,980</td>
                </tr>
                <tr>
                    <td>4230</td>
                    <td>Pankaj Ghokar</td>
                    <td>Nashik Wada</td>
                    <td>579,592</td>
                    <td>637</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>10,32,812</td>
                    <td>3</td>
                    <td>100.00</td>
                    <td>10,32,812</td>
                </tr>
                <tr>
                    <td>3288</td>
                    <td>Yashaswi Sundaram</td>
                    <td>Nashik Wada</td>
                    <td>774,474</td>
                    <td>598</td>
                    <td>Self Employed</td>
                    <td>3</td>
                    <td>17,46,446</td>
                    <td>2</td>
                    <td>66.67</td>
                    <td>12,95,434</td>
                </tr>
                <tr>
                    <td>3728</td>
                    <td>Jai Tailor</td>
                    <td>Coimbatore Kot</td>
                    <td>417,190</td>
                    <td>582</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>15,44,170</td>
                    <td>2</td>
                    <td>66.67</td>
                    <td>12,51,009</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>📊 What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> 100% default rates with actual loss amounts of ₹15.07L and ₹10.33L per customer</p>
            <p><strong>Why It's Important:</strong> These are not percentages - these are actual rupees lost. Raghav Dubey alone has caused ₹15.07L in losses with 100% default rate. This level of loss per customer justifies immediate legal action and represents the core of the portfolio crisis</p>
        </div>

        <div class="learning-tip">
            <h4>✅ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>100.0 vs 100</strong> - Decimal multiplication ensures accurate percentage calculation</li>
                <li><strong>HAVING vs WHERE</strong> - HAVING filters after GROUP BY aggregation</li>
                <li><strong>Loss amounts</strong> - Real rupees lost, not theoretical risk</li>
            </ul>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="section">
        <h3>STEP 3D: Executive-Friendly Formatting (Business Presentation)</h3>
        <p><strong>Business Rationale:</strong> Converting raw rupee amounts to Lakhs format for executive consumption and adding contact information for immediate action. Indian executives think in Lakhs and Crores, not raw rupee amounts.</p>
        
        <div class="code-block">-- Step 3D: Executive formatting with contact information for action
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    c.customer_id,
    c.full_name,
    dc.city_name,
    ds.state_name,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'₹'</span>, <span class="sql-function">ROUND</span>(c.annual_income/100000, 1), <span class="sql-string">'L'</span>) <span class="sql-keyword">AS</span> income,
    c.cibil_score,
    c.employment_type,
    c.phone_number,
    c.email_address,
    
    <span class="code-comment">-- Portfolio metrics in business-friendly format</span>
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'₹'</span>, <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/100000, 1), <span class="sql-string">'L'</span>) <span class="sql-keyword">AS</span> exposure,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    
    <span class="code-comment">-- Risk metrics</span>
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> personal_default_rate,
    
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'₹'</span>, <span class="sql-function">ROUND</span>(
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>)/100000, 1
    ), <span class="sql-string">'L'</span>) <span class="sql-keyword">AS</span> losses
<span class="sql-keyword">FROM</span> customers c
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> c.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> c.customer_id = l.customer_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> c.customer_id, c.full_name, dc.city_name, ds.state_name,
         c.annual_income, c.cibil_score, c.employment_type, c.phone_number, c.email_address
<span class="sql-keyword">HAVING</span> <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) > 0
<span class="sql-keyword">ORDER BY</span> <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>🔍 Detailed Query Explanation:</h4>
            <ul>
                <li><strong>CONCAT('₹', ROUND(...), 'L'):</strong> Formats amounts in Lakhs with Indian currency symbol for executive readability</li>
                <li><strong>/100000 calculation:</strong> Converts rupees to Lakhs (₹15,06,980 becomes ₹15.1L)</li>
                <li><strong>phone_number, email_address:</strong> Critical contact information for immediate collection action</li>
                <li><strong>state_name addition:</strong> Geographic context for legal jurisdiction and field deployment</li>
                <li><strong>Business format benefits:</strong> ₹15.1L is immediately comprehensible vs 1506980</li>
                <li><strong>Actionable data:</strong> All information needed for immediate contact and legal proceedings</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>customer_id</th>
                    <th>full_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>income</th>
                    <th>cibil_score</th>
                    <th>employment_type</th>
                    <th>phone_number</th>
                    <th>email_address</th>
                    <th>total_loans</th>
                    <th>exposure</th>
                    <th>defaulted_loans</th>
                    <th>personal_default_rate</th>
                    <th>losses</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1047</td>
                    <td>Raghav Dubey</td>
                    <td>Guwahati Wada</td>
                    <td>Assam</td>
                    <td>₹2.3L</td>
                    <td>486</td>
                    <td>Self Employed</td>
                    <td>+91 9876543210</td>
                    <td>raghav.dubey@gmail.com</td>
                    <td>3</td>
                    <td>₹15.1L</td>
                    <td>3</td>
                    <td>100.00</td>
                    <td>₹15.1L</td>
                </tr>
                <tr>
                    <td>4230</td>
                    <td>Pankaj Ghokar</td>
                    <td>Nashik Wada</td>
                    <td>Maharashtra</td>
                    <td>₹5.8L</td>
                    <td>637</td>
                    <td>Private Employee</td>
                    <td>+91 9876543211</td>
                    <td>pankaj.ghokar@yahoo.com</td>
                    <td>3</td>
                    <td>₹10.3L</td>
                    <td>3</td>
                    <td>100.00</td>
                    <td>₹10.3L</td>
                </tr>
                <tr>
                    <td>3288</td>
                    <td>Yashaswi Sundaram</td>
                    <td>Nashik Wada</td>
                    <td>Maharashtra</td>
                    <td>₹7.7L</td>
                    <td>598</td>
                    <td>Self Employed</td>
                    <td>+91 9876543212</td>
                    <td>yashaswi.s@outlook.com</td>
                    <td>3</td>
                    <td>₹17.5L</td>
                    <td>2</td>
                    <td>66.67</td>
                    <td>₹13.0L</td>
                </tr>
                <tr>
                    <td>3728</td>
                    <td>Jai Tailor</td>
                    <td>Coimbatore Kot</td>
                    <td>Tamil Nadu</td>
                    <td>₹4.2L</td>
                    <td>582</td>
                    <td>Private Employee</td>
                    <td>+91 9876543213</td>
                    <td>jai.tailor@gmail.com</td>
                    <td>3</td>
                    <td>₹15.4L</td>
                    <td>2</td>
                    <td>66.67</td>
                    <td>₹12.5L</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>📊 What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Executive-ready dashboard with contact details for immediate action on highest-loss customers</p>
            <p><strong>Why It's Important:</strong> Raghav Dubey (₹15.1L loss) can be contacted immediately at +91 9876543210. Collection teams have all data needed for legal notice, field visit, or aggressive collection. Format enables rapid executive decision-making</p>
        </div>

        <div class="learning-tip">
            <h4>✅ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>CONCAT function</strong> combines text and numbers for formatted output</li>
                <li><strong>Division by 100000</strong> converts rupees to Lakhs for Indian business context</li>
                <li><strong>Contact information</strong> makes analysis actionable, not just informational</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 3E: Risk Classification Logic (Decision Framework)</h3>
        <p><strong>Business Rationale:</strong> Create sophisticated business logic that combines multiple risk factors (defaults, exposure, CIBIL) to categorize customers into clear action buckets. This enables immediate resource allocation decisions.</p>
        
        <div class="code-block">-- Step 3E: Multi-factor risk categorization for action planning
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 10
    c.customer_id,
    c.full_name,
    dc.city_name,
    ds.state_name,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'₹'</span>, <span class="sql-function">ROUND</span>(c.annual_income/100000, 1), <span class="sql-string">'L'</span>) <span class="sql-keyword">AS</span> income,
    c.cibil_score,
    c.employment_type,
    <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'₹'</span>, <span class="sql-function">ROUND</span>(<span class="sql-function">SUM</span>(l.loan_amount)/100000, 1), <span class="sql-string">'L'</span>) <span class="sql-keyword">AS</span> exposure,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(l.loan_id), 2
    ) <span class="sql-keyword">AS</span> personal_default_rate,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'₹'</span>, <span class="sql-function">ROUND</span>(
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>)/100000, 1
    ), <span class="sql-string">'L'</span>) <span class="sql-keyword">AS</span> losses,
    
    <span class="code-comment">-- Multi-factor risk categorization logic</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) >= 2 
             <span class="sql-keyword">AND</span> <span class="sql-function">SUM</span>(l.loan_amount) > 500000 <span class="sql-keyword">THEN</span> <span class="sql-string">'EXTREME RISK'</span>
        <span class="sql-keyword">WHEN</span> (<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / <span class="sql-function">COUNT</span>(l.loan_id)) >= 50 
             <span class="sql-keyword">AND</span> <span class="sql-function">SUM</span>(l.loan_amount) > 300000 <span class="sql-keyword">THEN</span> <span class="sql-string">'HIGH RISK'</span>
        <span class="sql-keyword">WHEN</span> c.cibil_score < 650 <span class="sql-keyword">AND</span> <span class="sql-function">COUNT</span>(l.loan_id) > 1 <span class="sql-keyword">THEN</span> <span class="sql-string">'CREDIT RISK'</span>
        <span class="sql-keyword">WHEN</span> <span class="sql-function">SUM</span>(l.loan_amount) > 1000000 <span class="sql-keyword">THEN</span> <span class="sql-string">'HIGH EXPOSURE'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'STANDARD'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> risk_category
<span class="sql-keyword">FROM</span> customers c
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> c.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> c.customer_id = l.customer_id
<span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> c.customer_id, c.full_name, dc.city_name, ds.state_name,
         c.annual_income, c.cibil_score, c.employment_type
<span class="sql-keyword">HAVING</span> (<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) > 0 
        <span class="sql-keyword">OR</span> c.cibil_score < 650 
        <span class="sql-keyword">OR</span> <span class="sql-function">SUM</span>(l.loan_amount) > 300000)
<span class="sql-keyword">ORDER BY</span> <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">DESC</span>;</div>

        <div class="query-explanation">
            <h4>🔍 Detailed Query Explanation:</h4>
            <ul>
                <li><strong>EXTREME RISK logic:</strong> 2+ defaults AND >₹5L exposure = immediate legal action required</li>
                <li><strong>HIGH RISK logic:</strong> 50%+ default rate AND >₹3L exposure = aggressive collection needed</li>
                <li><strong>CREDIT RISK logic:</strong> CIBIL <650 AND multiple loans = restructuring candidate</li>
                <li><strong>HIGH EXPOSURE logic:</strong> >₹10L total exposure = preventive monitoring regardless of defaults</li>
                <li><strong>HAVING multi-condition:</strong> Includes any customer meeting risk criteria (defaults OR low CIBIL OR high exposure)</li>
                <li><strong>Nested logic evaluation:</strong> CASE evaluates conditions in order, assigns first matching category</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>customer_id</th>
                    <th>full_name</th>
                    <th>city_name</th>
                    <th>state_name</th>
                    <th>income</th>
                    <th>cibil_score</th>
                    <th>employment_type</th>
                    <th>total_loans</th>
                    <th>exposure</th>
                    <th>defaulted_loans</th>
                    <th>personal_default_rate</th>
                    <th>losses</th>
                    <th>risk_category</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1047</td>
                    <td>Raghav Dubey</td>
                    <td>Guwahati Wada</td>
                    <td>Assam</td>
                    <td>₹2.3L</td>
                    <td>486</td>
                    <td>Self Employed</td>
                    <td>3</td>
                    <td>₹15.1L</td>
                    <td>3</td>
                    <td>100.00</td>
                    <td>₹15.1L</td>
                    <td>EXTREME RISK</td>
                </tr>
                <tr>
                    <td>4230</td>
                    <td>Pankaj Ghokar</td>
                    <td>Nashik Wada</td>
                    <td>Maharashtra</td>
                    <td>₹5.8L</td>
                    <td>637</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>₹10.3L</td>
                    <td>3</td>
                    <td>100.00</td>
                    <td>₹10.3L</td>
                    <td>EXTREME RISK</td>
                </tr>
                <tr>
                    <td>3288</td>
                    <td>Yashaswi Sundaram</td>
                    <td>Nashik Wada</td>
                    <td>Maharashtra</td>
                    <td>₹7.7L</td>
                    <td>598</td>
                    <td>Self Employed</td>
                    <td>3</td>
                    <td>₹17.5L</td>
                    <td>2</td>
                    <td>66.67</td>
                    <td>₹13.0L</td>
                    <td>EXTREME RISK</td>
                </tr>
                <tr>
                    <td>3728</td>
                    <td>Jai Tailor</td>
                    <td>Coimbatore Kot</td>
                    <td>Tamil Nadu</td>
                    <td>₹4.2L</td>
                    <td>582</td>
                    <td>Private Employee</td>
                    <td>3</td>
                    <td>₹15.4L</td>
                    <td>2</td>
                    <td>66.67</td>
                    <td>₹12.5L</td>
                    <td>EXTREME RISK</td>
                </tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>📊 What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Clear risk categorization showing all top customers fall into EXTREME RISK category</p>
            <p><strong>Why It's Important:</strong> No ambiguity in action required - all these customers meet EXTREME RISK criteria (2+ defaults + ₹5L+ exposure). This classification drives immediate legal action deployment and justifies senior resource allocation</p>
        </div>

        <div class="learning-tip">
            <h4>✅ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>Nested CASE logic</strong> evaluates conditions in order until one matches</li>
                <li><strong>AND conditions</strong> require both criteria to be true for classification</li>
                <li><strong>Business rule translation</strong> converts complex criteria into clear categories</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>🔧 COMPLETE VALIDATED QUERY</h2>
        <p><strong>Business Purpose:</strong> This comprehensive customer risk analysis query creates an executive-ready dashboard that combines demographic data, financial exposure, default behavior, contact information, and automated action recommendations for immediate collection and legal deployment decisions.</p>
        
        <div class="code-block">-- STEP 3: Customer Risk Segmentation - VALIDATED & TESTED
<span class="sql-keyword">WITH</span> customer_risk_profile <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        c.customer_id,
        c.full_name,
        dc.city_name,
        ds.state_name,
        ds.region,
        c.annual_income,
        c.cibil_score,
        c.employment_type,
        c.phone_number,
        c.email_address,
        
        <span class="code-comment">-- Loan portfolio per customer</span>
        <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> total_loans,
        <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> total_exposure,
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_loans,
        
        <span class="code-comment">-- Risk calculations</span>
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) <span class="sql-keyword">AS</span> personal_default_rate,
        
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> loss_amount
        
    <span class="sql-keyword">FROM</span> customers c
    <span class="sql-keyword">INNER JOIN</span> dim_city dc <span class="sql-keyword">ON</span> c.city_id = dc.city_id
    <span class="sql-keyword">INNER JOIN</span> dim_state ds <span class="sql-keyword">ON</span> dc.state_id = ds.state_id
    <span class="sql-keyword">INNER JOIN</span> loans l <span class="sql-keyword">ON</span> c.customer_id = l.customer_id
    <span class="sql-keyword">WHERE</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    <span class="sql-keyword">GROUP BY</span> c.customer_id, c.full_name, dc.city_name, ds.state_name, ds.region,
             c.annual_income, c.cibil_score, c.employment_type, c.phone_number, c.email_address
)
<span class="sql-keyword">SELECT</span> <span class="sql-keyword">TOP</span> 50
    customer_id,
    full_name,
    city_name,
    state_name,
    region,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'₹'</span>, <span class="sql-function">ROUND</span>(annual_income/100000, 1), <span class="sql-string">'L'</span>) <span class="sql-keyword">AS</span> income,
    cibil_score,
    employment_type,
    phone_number,
    email_address,
    total_loans,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'₹'</span>, <span class="sql-function">ROUND</span>(total_exposure/100000, 1), <span class="sql-string">'L'</span>) <span class="sql-keyword">AS</span>