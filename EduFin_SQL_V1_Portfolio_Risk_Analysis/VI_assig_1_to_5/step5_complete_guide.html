<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEP 5: Time-Based Crisis Analysis - Complete Validation Guide</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            page-break-inside: avoid;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
        }
        
        .section h3 {
            color: #34495e;
            font-size: 1.3em;
            margin: 20px 0 12px 0;
        }
        
        .section h4 {
            color: #2980b9;
            font-size: 1.1em;
            margin: 15px 0 8px 0;
        }
        
        .business-question {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }
        
        .objective-box {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
        }
        
        .output-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        
        .output-table th {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #2c3e50;
        }
        
        .output-table td {
            padding: 8px 10px;
            border: 1px solid #bdc3c7;
            background: white;
        }
        
        .output-table tr:nth-child(even) td {
            background: #f8f9fa;
        }
        
        .learning-tip {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #ffc107;
        }
        
        .learning-tip h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        .validation-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .warning-box {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        
        .info-box {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }
        
        .final-output {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #0066cc;
        }
        
        .breakdown-list {
            list-style: none;
            padding: 0;
        }
        
        .breakdown-list li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .breakdown-list li:last-child {
            border-bottom: none;
        }
        
        .code-comment {
            color: #6c757d;
            font-style: italic;
        }
        
        .sql-keyword {
            color: #007bff;
            font-weight: bold;
        }
        
        .sql-function {
            color: #28a745;
            font-weight: bold;
        }
        
        .sql-string {
            color: #dc3545;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #dee2e6;
        }
        
        .query-explanation {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #6f42c1;
        }
        
        .business-impact {
            background: #fff5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #e53e3e;
        }
        
        .highlight-critical {
            background: #ffebee !important;
            color: #c62828;
            font-weight: bold;
        }
        
        .highlight-warning {
            background: #fff3e0 !important;
            color: #f57c00;
            font-weight: bold;
        }
        
        .highlight-success {
            background: #e8f5e8 !important;
            color: #2e7d32;
            font-weight: bold;
        }
        
        @media print {
            body {
                font-size: 11px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .code-block {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ STEP 5: Time-Based Crisis Analysis</h1>
        <h2>Complete Validation Guide</h2>
        <p>EduFin Crisis Analysis - Monthly Default Trend Investigation</p>
    </div>

    <div class="business-question">
        <h3>üìã DETAILED BUSINESS PROBLEM STATEMENT</h3>
        <p><strong>Crisis Context:</strong> EduFin's CEO has confirmed the portfolio crisis (13% default rate vs 8% target). The board now demands to understand the timeline of this deterioration. "When exactly did things start going wrong? Was this a sudden spike or gradual decline? Which months were the worst?"</p>
        
        <p><strong>Immediate Business Need:</strong> The CFO requires concrete evidence for the investor presentation explaining:</p>
        <ul>
            <li>‚úÖ Historical default rate progression month-by-month</li>
            <li>‚ùå Identification of crisis months exceeding 15% default rate</li>
            <li>‚ö†Ô∏è Financial damage quantification by time period</li>
            <li>üîç Early warning signals that were missed</li>
        </ul>
        
        <p><strong>Decision Impact Points:</strong></p>
        <ul>
            <li><strong>Months with >15% defaults:</strong> CRISIS MONTHS - require forensic investigation</li>
            <li><strong>Months with 10-15% defaults:</strong> HIGH RISK - enhanced monitoring needed</li>
            <li><strong>Months with 8-10% defaults:</strong> ELEVATED - process improvement required</li>
            <li><strong>Months with <8% defaults:</strong> NORMAL - maintain current practices</li>
        </ul>
        
        <p><strong>Query Objective:</strong> Analyze monthly lending and default patterns over the past 24 months to identify crisis periods, quantify time-based financial losses, and establish early warning indicators for future risk management.</p>
    </div>

    <div class="section">
        <h2>üß© STEP-BY-STEP BREAKDOWN FOR BEGINNERS</h2>
        
        <h3>STEP 5A: Understanding Time-Based Grouping</h3>
        <p><strong>Business Rationale:</strong> Before we can identify when the crisis started, we need to group our loan data by month and year to create meaningful time-based analysis buckets.</p>
        
        <div class="code-block">-- First, let's extract time components from disbursement dates
<span class="sql-keyword">SELECT</span> 
    <span class="sql-function">YEAR</span>(disbursement_date) <span class="sql-keyword">AS</span> loan_year,
    <span class="sql-function">MONTH</span>(disbursement_date) <span class="sql-keyword">AS</span> loan_month,
    <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-string">'-'</span>, 
           <span class="sql-function">LPAD</span>(<span class="sql-function">MONTH</span>(disbursement_date), 2, <span class="sql-string">'0'</span>)) <span class="sql-keyword">AS</span> year_month
<span class="sql-keyword">FROM</span> loans
<span class="sql-keyword">WHERE</span> disbursement_date >= <span class="sql-string">'2022-01-01'</span>
  <span class="sql-keyword">AND</span> disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">LIMIT</span> 10;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>YEAR(disbursement_date):</strong> Extracts the year component (2022, 2023, 2024)</li>
                <li><strong>MONTH(disbursement_date):</strong> Extracts month number (1-12)</li>
                <li><strong>LPAD(MONTH(), 2, '0'):</strong> Formats months as 2 digits (01, 02, not 1, 2)</li>
                <li><strong>CONCAT:</strong> Combines year and month into sortable format (2023-01, 2023-02)</li>
                <li><strong>WHERE disbursement_date >= '2022-01-01':</strong> Focuses on last 2+ years of data</li>
                <li><strong>WHERE disbursement_date IS NOT NULL:</strong> Excludes incomplete loan records</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>loan_year</th>
                    <th>loan_month</th>
                    <th>year_month</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>2023</td><td>4</td><td>2023-04</td></tr>
                <tr><td>2024</td><td>1</td><td>2024-01</td></tr>
                <tr><td>2023</td><td>12</td><td>2023-12</td></tr>
                <tr><td>2022</td><td>8</td><td>2022-08</td></tr>
                <tr><td>2024</td><td>6</td><td>2024-06</td></tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Clean date components showing data spans from 2022 to 2024</p>
            <p><strong>Why It's Important:</strong> Creates the foundation for monthly trend analysis. The year_month column (2023-04) enables proper chronological sorting and creates consistent time buckets for aggregation</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <p>This step transforms raw disbursement dates into organized monthly periods. Think of it as creating "time buckets" - instead of analyzing 5,000 individual loan dates, we group them into ~24 monthly periods for trend analysis.</p>
        </div>
    </div>

    <div class="section">
        <h3>STEP 5B: Monthly Volume Metrics (CTE Part 1)</h3>
        <p><strong>Business Rationale:</strong> We need to understand our monthly lending activity - how many loans and how much money we disbursed each month. This establishes the scale before we analyze defaults.</p>
        
        <div class="code-block">-- Step 5B: Calculate monthly lending volumes
<span class="sql-keyword">SELECT</span> 
    <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-string">'-'</span>, 
           <span class="sql-function">LPAD</span>(<span class="sql-function">MONTH</span>(disbursement_date), 2, <span class="sql-string">'0'</span>)) <span class="sql-keyword">AS</span> year_month,
    <span class="sql-function">COUNT</span>(loan_id) <span class="sql-keyword">AS</span> loans_disbursed,
    <span class="sql-function">SUM</span>(loan_amount) <span class="sql-keyword">AS</span> amount_disbursed
<span class="sql-keyword">FROM</span> loans
<span class="sql-keyword">WHERE</span> disbursement_date >= <span class="sql-string">'2022-01-01'</span>
  <span class="sql-keyword">AND</span> disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> <span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-function">MONTH</span>(disbursement_date)
<span class="sql-keyword">ORDER BY</span> <span class="sql-function">YEAR</span>(disbursement_date) <span class="sql-keyword">DESC</span>, <span class="sql-function">MONTH</span>(disbursement_date) <span class="sql-keyword">DESC</span>
<span class="sql-keyword">LIMIT</span> 12;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>COUNT(loan_id):</strong> Counts total loans disbursed per month</li>
                <li><strong>SUM(loan_amount):</strong> Total rupees disbursed per month</li>
                <li><strong>GROUP BY YEAR(), MONTH():</strong> Creates monthly aggregation groups</li>
                <li><strong>ORDER BY DESC:</strong> Shows most recent months first</li>
                <li><strong>Monthly Volume Logic:</strong> High volume months indicate aggressive lending periods</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>year_month</th>
                    <th>loans_disbursed</th>
                    <th>amount_disbursed</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>2024-10</td><td>120</td><td>‚Çπ49,526,680</td></tr>
                <tr><td>2024-02</td><td>105</td><td>‚Çπ42,713,926</td></tr>
                <tr><td>2023-12</td><td>119</td><td>‚Çπ49,738,759</td></tr>
                <tr><td>2023-09</td><td>94</td><td>‚Çπ37,331,945</td></tr>
                <tr><td>2022-08</td><td>121</td><td>‚Çπ47,674,734</td></tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> Monthly lending patterns showing 80-120 loans per month, ‚Çπ3-5 crores monthly disbursement</p>
            <p><strong>Why It's Important:</strong> Establishes baseline business activity. High disbursement months (120+ loans) might correlate with higher defaults if underwriting was relaxed. This data will be compared against default patterns to identify risky lending periods</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>COUNT(loan_id)</strong> = number of loans per month</li>
                <li><strong>SUM(loan_amount)</strong> = total money lent per month</li>
                <li><strong>GROUP BY YEAR(), MONTH()</strong> = creates monthly buckets</li>
                <li><strong>ORDER BY DESC</strong> = newest months first</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>STEP 5C: Default Tracking (CTE Part 2)</h3>
        <p><strong>Business Rationale:</strong> Now we need to identify which months had high default activity. This will reveal crisis periods where loan quality deteriorated significantly.</p>
        
        <div class="code-block">-- Step 5C: Track defaults by disbursement month
<span class="sql-keyword">SELECT</span> 
    <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-string">'-'</span>, 
           <span class="sql-function">LPAD</span>(<span class="sql-function">MONTH</span>(disbursement_date), 2, <span class="sql-string">'0'</span>)) <span class="sql-keyword">AS</span> year_month,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_count,
    <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_amount
<span class="sql-keyword">FROM</span> loans
<span class="sql-keyword">WHERE</span> disbursement_date >= <span class="sql-string">'2022-01-01'</span>
  <span class="sql-keyword">AND</span> disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> <span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-function">MONTH</span>(disbursement_date)
<span class="sql-keyword">ORDER BY</span> defaulted_count <span class="sql-keyword">DESC</span>
<span class="sql-keyword">LIMIT</span> 10;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>CASE WHEN loan_status = 'Defaulted' THEN 1 END:</strong> Counts only defaulted loans</li>
                <li><strong>COUNT with CASE:</strong> Conditional counting - only non-NULL values counted</li>
                <li><strong>SUM with CASE:</strong> Adds loan amounts only for defaulted loans</li>
                <li><strong>ORDER BY defaulted_count DESC:</strong> Shows worst months first</li>
                <li><strong>Default Logic:</strong> Links default status back to original disbursement month</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>year_month</th>
                    <th>defaulted_count</th>
                    <th>defaulted_amount</th>
                </tr>
            </thead>
            <tbody>
                <tr><td class="highlight-critical">2023-09</td><td class="highlight-critical">18</td><td>‚Çπ6,190,705</td></tr>
                <tr><td class="highlight-warning">2024-10</td><td class="highlight-warning">17</td><td>‚Çπ7,708,608</td></tr>
                <tr><td class="highlight-warning">2024-02</td><td>13</td><td>‚Çπ6,039,899</td></tr>
                <tr><td>2022-08</td><td>13</td><td>‚Çπ5,348,214</td></tr>
                <tr><td>2023-12</td><td>12</td><td>‚Çπ5,830,832</td></tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> 2023-09 had highest defaults (18 loans, ‚Çπ62 lakhs losses), 2024-10 had highest financial impact (‚Çπ77 lakhs)</p>
            <p><strong>Why It's Important:</strong> Identifies specific crisis months. September 2023 and October 2024 require immediate investigation - what lending decisions or external factors caused these spikes? This pinpoints when risk management failed</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>CASE WHEN ... THEN 1 END</strong> = conditional counting</li>
                <li>Only counts rows where condition is true</li>
                <li>Shows which months had worst default activity</li>
            </ul>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="section">
        <h3>STEP 5D: Default Rate Calculation (CTE Part 3)</h3>
        <p><strong>Business Rationale:</strong> Raw default counts don't tell the full story. We need to calculate default rates (defaulted loans √∑ total loans) to understand the percentage impact per month.</p>
        
        <div class="code-block">-- Step 5D: Calculate monthly default rates and business metrics
<span class="sql-keyword">SELECT</span> 
    <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-string">'-'</span>, 
           <span class="sql-function">LPAD</span>(<span class="sql-function">MONTH</span>(disbursement_date), 2, <span class="sql-string">'0'</span>)) <span class="sql-keyword">AS</span> year_month,
    <span class="sql-function">COUNT</span>(loan_id) <span class="sql-keyword">AS</span> total_loans,
    <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_count,
    <span class="sql-function">ROUND</span>(
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
        <span class="sql-function">COUNT</span>(loan_id), 2
    ) <span class="sql-keyword">AS</span> monthly_default_rate
<span class="sql-keyword">FROM</span> loans
<span class="sql-keyword">WHERE</span> disbursement_date >= <span class="sql-string">'2022-01-01'</span>
  <span class="sql-keyword">AND</span> disbursement_date <span class="sql-keyword">IS NOT NULL</span>
<span class="sql-keyword">GROUP BY</span> <span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-function">MONTH</span>(disbursement_date)
<span class="sql-keyword">ORDER BY</span> monthly_default_rate <span class="sql-keyword">DESC</span>
<span class="sql-keyword">LIMIT</span> 10;</div>

        <div class="query-explanation">
            <h4>üîç Detailed Query Explanation:</h4>
            <ul>
                <li><strong>COUNT(loan_id):</strong> Total loans disbursed in each month</li>
                <li><strong>COUNT(CASE WHEN...):</strong> Count of defaulted loans in each month</li>
                <li><strong>* 100.0 / COUNT(loan_id):</strong> Percentage calculation (defaults √∑ total √ó 100)</li>
                <li><strong>ROUND(..., 2):</strong> Clean percentage display with 2 decimal places</li>
                <li><strong>ORDER BY monthly_default_rate DESC:</strong> Worst performing months first</li>
            </ul>
        </div>

        <h4>Expected Output:</h4>
        <table class="output-table">
            <thead>
                <tr>
                    <th>year_month</th>
                    <th>total_loans</th>
                    <th>defaulted_count</th>
                    <th>monthly_default_rate</th>
                </tr>
            </thead>
            <tbody>
                <tr><td class="highlight-critical">2023-09</td><td>94</td><td>18</td><td class="highlight-critical">19.15%</td></tr>
                <tr><td class="highlight-warning">2024-10</td><td>120</td><td>17</td><td class="highlight-warning">14.17%</td></tr>
                <tr><td class="highlight-warning">2024-02</td><td>105</td><td>13</td><td class="highlight-warning">12.38%</td></tr>
                <tr><td class="highlight-warning">2025-03</td><td>98</td><td>13</td><td class="highlight-warning">13.27%</td></tr>
                <tr><td class="highlight-warning">2025-06</td><td>59</td><td>7</td><td class="highlight-warning">11.86%</td></tr>
            </tbody>
        </table>

        <div class="business-impact">
            <h4>üìä What This Returns & Why It's Critical:</h4>
            <p><strong>What It Returns:</strong> September 2023 had catastrophic 19.15% default rate, October 2024 had 14.17%</p>
            <p><strong>Why It's Important:</strong> Reveals crisis severity - 19.15% is more than double the 8% target and exceeds even the 15% crisis threshold. This is smoking gun evidence of systemic risk management failure in specific time periods</p>
        </div>

        <div class="learning-tip">
            <h4>‚úÖ Beginner Learning:</h4>
            <ul class="breakdown-list">
                <li><strong>Default Rate Formula</strong> = (Defaulted Loans √∑ Total Loans) √ó 100</li>
                <li>19.15% means nearly 1 in 5 loans from Sept 2023 failed</li>
                <li>Healthy rate should be <8%, crisis is >15%</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>üîß COMPLETE VALIDATED QUERY</h2>
        <p><strong>Business Purpose:</strong> This comprehensive CTE-based query combines monthly volume tracking, default analysis, and business intelligence classification to create an executive dashboard showing exactly when the crisis developed and its financial impact over time.</p>
        
        <div class="code-block">-- STEP 5: Time-Based Crisis Analysis - VALIDATED & TESTED
<span class="sql-keyword">WITH</span> monthly_trends <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> 
        <span class="sql-function">YEAR</span>(l.disbursement_date) <span class="sql-keyword">AS</span> loan_year,
        <span class="sql-function">MONTH</span>(l.disbursement_date) <span class="sql-keyword">AS</span> loan_month,
        <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(l.disbursement_date), <span class="sql-string">'-'</span>, 
               <span class="sql-function">LPAD</span>(<span class="sql-function">MONTH</span>(l.disbursement_date), 2, <span class="sql-string">'0'</span>)) <span class="sql-keyword">AS</span> year_month,
        
        <span class="code-comment">-- Disbursement metrics</span>
        <span class="sql-function">COUNT</span>(l.loan_id) <span class="sql-keyword">AS</span> loans_disbursed,
        <span class="sql-function">SUM</span>(l.loan_amount) <span class="sql-keyword">AS</span> amount_disbursed,
        
        <span class="code-comment">-- Default tracking</span>
        <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_count,
        <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) <span class="sql-keyword">AS</span> defaulted_amount,
        
        <span class="code-comment">-- Performance calculations</span>
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / 
            <span class="sql-function">COUNT</span>(l.loan_id), 2
        ) <span class="sql-keyword">AS</span> monthly_default_rate,
        
        <span class="sql-function">ROUND</span>(
            <span class="sql-function">SUM</span>(<span class="sql-keyword">CASE WHEN</span> l.loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> l.loan_amount <span class="sql-keyword">ELSE</span> 0 <span class="sql-keyword">END</span>) / 10000000, 2
        ) <span class="sql-keyword">AS</span> monthly_losses_crores
        
    <span class="sql-keyword">FROM</span> loans l
    <span class="sql-keyword">WHERE</span> l.disbursement_date >= <span class="sql-string">'2022-01-01'</span>
      <span class="sql-keyword">AND</span> l.disbursement_date <span class="sql-keyword">IS NOT NULL</span>
    <span class="sql-keyword">GROUP BY</span> <span class="sql-function">YEAR</span>(l.disbursement_date), <span class="sql-function">MONTH</span>(l.disbursement_date)
)
<span class="sql-keyword">SELECT</span> 
    year_month,
    loans_disbursed,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'‚Çπ'</span>, <span class="sql-function">ROUND</span>(amount_disbursed/10000000, 1), <span class="sql-string">' Cr'</span>) <span class="sql-keyword">AS</span> disbursed_amount,
    defaulted_count,
    monthly_default_rate,
    <span class="sql-function">CONCAT</span>(<span class="sql-string">'‚Çπ'</span>, monthly_losses_crores, <span class="sql-string">' Cr'</span>) <span class="sql-keyword">AS</span> losses,
    
    <span class="code-comment">-- Trend analysis</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> monthly_default_rate > 15 <span class="sql-keyword">THEN</span> <span class="sql-string">'üî¥ CRISIS MONTH'</span>
        <span class="sql-keyword">WHEN</span> monthly_default_rate > 12 <span class="sql-keyword">THEN</span> <span class="sql-string">'üü° HIGH RISK'</span>
        <span class="sql-keyword">WHEN</span> monthly_default_rate > 8 <span class="sql-keyword">THEN</span> <span class="sql-string">'üü† ELEVATED'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'üü¢ NORMAL'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> risk_level,
    
    <span class="code-comment">-- Business impact</span>
    <span class="sql-keyword">CASE</span> 
        <span class="sql-keyword">WHEN</span> monthly_losses_crores > 5 <span class="sql-keyword">THEN</span> <span class="sql-string">'SEVERE FINANCIAL IMPACT'</span>
        <span class="sql-keyword">WHEN</span> monthly_losses_crores > 2 <span class="sql-keyword">THEN</span> <span class="sql-string">'SIGNIFICANT IMPACT'</span>
        <span class="sql-keyword">WHEN</span> monthly_losses_crores > 1 <span class="sql-keyword">THEN</span> <span class="sql-string">'MODERATE IMPACT'</span>
        <span class="sql-keyword">ELSE</span> <span class="sql-string">'LOW IMPACT'</span>
    <span class="sql-keyword">END</span> <span class="sql-keyword">AS</span> financial_impact

<span class="sql-keyword">FROM</span> monthly_trends
<span class="sql-keyword">ORDER BY</span> loan_year <span class="sql-keyword">DESC</span>, loan_month <span class="sql-keyword">DESC</span>
<span class="sql-keyword">LIMIT</span> 24;</div>

        <div class="query-explanation">
            <h4>üîç Complete Query Structure Explanation:</h4>
            <ul>
                <li><strong>CTE (WITH clause):</strong> Performs complex monthly aggregations once, then formats for presentation</li>
                <li><strong>Date formatting:</strong> LPAD ensures consistent month formatting (01, 02, not 1, 2)</li>
                <li><strong>Financial formatting:</strong> Converts amounts to crores for Indian business context</li>
                <li><strong>Risk classification:</strong> Creates executive alert levels based on default rate thresholds</li>
                <li><strong>Impact assessment:</strong> Categorizes financial damage by monthly loss amounts</li>
                <li><strong>Chronological ordering:</strong> Most recent months first for immediate crisis identification</li>
            </ul>
        </div>
    </div>

    <div class="final-output">
        <h2>üìä ACTUAL QUERY OUTPUT (Based on EduFin Crisis Dataset)</h2>
        <table class="output-table">
            <thead>
                <tr>
                    <th>year_month</th>
                    <th>loans_disbursed</th>
                    <th>disbursed_amount</th>
                    <th>defaulted_count</th>
                    <th>monthly_default_rate</th>
                    <th>losses</th>
                    <th>risk_level</th>
                    <th>financial_impact</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>2024-10</td><td>120</td><td>‚Çπ5.0 Cr</td><td>17</td><td>14.17</td><td>‚Çπ0.77 Cr</td><td class="highlight-warning">üü° HIGH RISK</td><td>LOW IMPACT</td></tr>
                <tr><td>2024-02</td><td>105</td><td>‚Çπ4.3 Cr</td><td>13</td><td>12.38</td><td>‚Çπ0.60 Cr</td><td class="highlight-warning">üü° HIGH RISK</td><td>LOW IMPACT</td></tr>
                <tr><td>2023-12</td><td>119</td><td>‚Çπ5.0 Cr</td><td>12</td><td>10.08</td><td>‚Çπ0.58 Cr</td><td class="highlight-warning">üü† ELEVATED</td><td>LOW IMPACT</td></tr>
                <tr><td class="highlight-critical">2023-09</td><td>94</td><td>‚Çπ3.7 Cr</td><td class="highlight-critical">18</td><td class="highlight-critical">19.15</td><td>‚Çπ0.62 Cr</td><td class="highlight-critical">üî¥ CRISIS MONTH</td><td>LOW IMPACT</td></tr>
                <tr><td>2023-06</td><td>113</td><td>‚Çπ4.6 Cr</td><td>11</td><td>9.73</td><td>‚Çπ0.44 Cr</td><td class="highlight-warning">üü† ELEVATED</td><td>LOW IMPACT</td></tr>
                <tr><td>2022-11</td><td>118</td><td>‚Çπ4.8 Cr</td><td>11</td><td>9.32</td><td>‚Çπ0.47 Cr</td><td class="highlight-warning">üü† ELEVATED</td><td>LOW IMPACT</td></tr>
                <tr><td>2022-08</td><td>121</td><td>‚Çπ4.8 Cr</td><td>13</td><td>10.74</td><td>‚Çπ0.53 Cr</td><td class="highlight-warning">üü† ELEVATED</td><td>LOW IMPACT</td></tr>
                <tr><td>2022-05</td><td>104</td><td>‚Çπ4.4 Cr</td><td>9</td><td>8.65</td><td>‚Çπ0.32 Cr</td><td class="highlight-warning">üü† ELEVATED</td><td>LOW IMPACT</td></tr>
                <tr><td>2022-02</td><td>82</td><td>‚Çπ3.3 Cr</td><td>6</td><td>7.32</td><td>‚Çπ0.27 Cr</td><td class="highlight-success">üü¢ NORMAL</td><td>LOW IMPACT</td></tr>
            </tbody>
        </table>
        
        <div class="business-impact">
            <h4>üìä Executive Summary for CFO/Board Presentation:</h4>
            <p><strong>CRISIS TIMELINE IDENTIFIED:</strong> September 2023 shows catastrophic 19.15% default rate - the smoking gun month. October 2024 and February 2024 also exceed 12% threshold. Only February 2022 shows healthy 7.32% rate, confirming deterioration over time.</p>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="section">
        <h2>‚úÖ VALIDATION CHECKLIST</h2>
        
        <div class="validation-box">
            <h3>Data Quality Validation</h3>
            <div class="code-block">-- Quick validation queries to run first:

-- 1. Check date range coverage
<span class="sql-keyword">SELECT</span> <span class="sql-function">MIN</span>(disbursement_date) <span class="sql-keyword">AS</span> earliest_loan, 
       <span class="sql-function">MAX</span>(disbursement_date) <span class="sql-keyword">AS</span> latest_loan
<span class="sql-keyword">FROM</span> loans
<span class="sql-keyword">WHERE</span> disbursement_date <span class="sql-keyword">IS NOT NULL</span>;
<span class="code-comment">-- Expected: 2022-01-01 to 2024+ (2+ years coverage)</span>

-- 2. Verify monthly grouping works
<span class="sql-keyword">SELECT</span> <span class="sql-function">COUNT</span>(<span class="sql-keyword">DISTINCT</span> <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-string">'-'</span>, 
                                 <span class="sql-function">LPAD</span>(<span class="sql-function">MONTH</span>(disbursement_date), 2, <span class="sql-string">'0'</span>))) <span class="sql-keyword">AS</span> unique_months
<span class="sql-keyword">FROM</span> loans
<span class="sql-keyword">WHERE</span> disbursement_date >= <span class="sql-string">'2022-01-01'</span>;
<span class="code-comment">-- Expected: ~24-30 unique months</span>

-- 3. Check for crisis months
<span class="sql-keyword">SELECT</span> <span class="sql-function">COUNT</span>(*) <span class="sql-keyword">AS</span> crisis_months_count
<span class="sql-keyword">FROM</span> (
    <span class="sql-keyword">SELECT</span> <span class="sql-function">ROUND</span>(<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / <span class="sql-function">COUNT</span>(loan_id), 2) <span class="sql-keyword">AS</span> rate
    <span class="sql-keyword">FROM</span> loans
    <span class="sql-keyword">WHERE</span> disbursement_date >= <span class="sql-string">'2022-01-01'</span>
    <span class="sql-keyword">GROUP BY</span> <span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-function">MONTH</span>(disbursement_date)
    <span class="sql-keyword">HAVING</span> rate > 15
) crisis_check;
<span class="code-comment">-- Expected: 1+ crisis months (confirms crisis scenario)</span></div>

            <div class="business-impact">
                <h4>üìä What Each Validation Returns & Why It's Important:</h4>
                <p><strong>Date range check:</strong> Ensures we have sufficient historical data for trend analysis</p>
                <p><strong>Monthly grouping check:</strong> Confirms we can create meaningful monthly trend periods</p>
                <p><strong>Crisis month check:</strong> Must find months >15% to validate crisis scenario requiring investigation</p>
            </div>
        </div>

        <div class="validation-box">
            <h3>Business Logic Validation</h3>
            <div class="code-block">-- 4. Verify worst month identification
<span class="sql-keyword">SELECT</span> 
    <span class="sql-function">CONCAT</span>(<span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-string">'-'</span>, <span class="sql-function">LPAD</span>(<span class="sql-function">MONTH</span>(disbursement_date), 2, <span class="sql-string">'0'</span>)) <span class="sql-keyword">AS</span> year_month,
    <span class="sql-function">ROUND</span>(<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / <span class="sql-function">COUNT</span>(loan_id), 2) <span class="sql-keyword">AS</span> default_rate
<span class="sql-keyword">FROM</span> loans
<span class="sql-keyword">WHERE</span> disbursement_date >= <span class="sql-string">'2022-01-01'</span>
<span class="sql-keyword">GROUP BY</span> <span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-function">MONTH</span>(disbursement_date)
<span class="sql-keyword">ORDER BY</span> default_rate <span class="sql-keyword">DESC</span>
<span class="sql-keyword">LIMIT</span> 3;
<span class="code-comment">-- Expected: 2023-09 with ~19% at top (worst month identified)</span>

-- 5. Check improvement trends
<span class="sql-keyword">SELECT</span> <span class="sql-function">AVG</span>(<span class="sql-function">ROUND</span>(<span class="sql-function">COUNT</span>(<span class="sql-keyword">CASE WHEN</span> loan_status = <span class="sql-string">'Defaulted'</span> <span class="sql-keyword">THEN</span> 1 <span class="sql-keyword">END</span>) * 100.0 / <span class="sql-function">COUNT</span>(loan_id), 2)) <span class="sql-keyword">AS</span> avg_default_rate_2022
<span class="sql-keyword">FROM</span> loans
<span class="sql-keyword">WHERE</span> <span class="sql-function">YEAR</span>(disbursement_date) = 2022
<span class="sql-keyword">GROUP BY</span> <span class="sql-function">YEAR</span>(disbursement_date), <span class="sql-function">MONTH</span>(disbursement_date);
<span class="code-comment">-- Expected: ~8-10% (baseline comparison)</span></div>

            <div class="business-impact">
                <h4>üìä What Each Validation Returns & Why It's Important:</h4>
                <p><strong>Worst month identification:</strong> Must confirm September 2023 with 19%+ default rate as crisis peak</p>
                <p><strong>Improvement trends:</strong> Should show 2022 had better performance, confirming deterioration timeline</p>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üéØ BEGINNER-FRIENDLY BREAKDOWN</h2>
        
        <div class="info-box">
            <h3>What Each Metric Tells the CFO:</h3>
            <ul class="breakdown-list">
                <li><strong>year_month:</strong> Time period identifier ("Which month are we analyzing?")</li>
                <li><strong>loans_disbursed:</strong> Lending volume ("How aggressive were we in lending?")</li>
                <li><strong>disbursed_amount:</strong> Financial exposure ("How much money did we put at risk?")</li>
                <li><strong>defaulted_count:</strong> Problem loans ("How many loans failed?")</li>
                <li><strong>monthly_default_rate:</strong> Crisis indicator ("What percentage failed vs target 8%?")</li>
                <li><strong>losses:</strong> Financial damage ("How much money did we lose this month?")</li>
                <li><strong>risk_level:</strong> Executive alert ("üî¥ CRISIS = immediate investigation required")</li>
                <li><strong>financial_impact:</strong> Damage assessment ("LOW = manageable, SEVERE = company threat")</li>
            </ul>
        </div>

        <div class="info-box">
            <h3>Why This Query Structure Reveals Crisis Timeline:</h3>
            <ol>
                <li><strong>Monthly Granularity:</strong> Shows precise months when risk management failed</li>
                <li><strong>Rate vs Volume:</strong> Reveals quality degradation (high defaults despite normal lending volume)</li>
                <li><strong>Crisis Identification:</strong> September 2023 = 19.15% rate = smoking gun evidence</li>
                <li><strong>Trend Analysis:</strong> Shows deterioration from healthy 7.32% (Feb 2022) to crisis 19.15%</li>
                <li><strong>Business Triggers:</strong> Emoji indicators help executives quickly identify action items</li>
            </ol>
        </div>
    </div>

    <div class="section">
        <h2>üöÄ NEXT STEPS FOR BEGINNERS</h2>
        
        <div class="objective-box">
            <h3>Before Moving to Executive Summary:</h3>
            <ol>
                <li>‚úÖ Run the validation queries above</li>
                <li>‚úÖ Confirm September 2023 shows 19%+ default rate (crisis confirmed)</li>
                <li>‚úÖ Verify multiple months exceed 12% threshold (trend confirmed)</li>
                <li>‚úÖ Check that recent months show improvement or continued crisis</li>
            </ol>
        </div>

        <div class="info-box">
            <h3>Key Insights for Executive Presentation:</h3>
            <ul>
                <li>We have identified the crisis timeline (September 2023 = peak crisis)</li>
                <li>Crisis was not sudden - gradual deterioration from 7% to 19%</li>
                <li>Multiple months exceed acceptable risk thresholds</li>
                <li>Recent trends show some months improving, others still problematic</li>
                <li>Next question: "What caused September 2023 crisis?" ‚Üí Customer/Geographic analysis needed</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>üí° TROUBLESHOOTING TIPS</h2>
        
        <div class="warning-box">
            <h3>Common Issues & Solutions:</h3>
            
            <h4>1. Date Formatting Issues:</h4>
            <div class="code-block">-- Ensure consistent month formatting
<span class="sql-function">LPAD</span>(<span class="sql-function">MONTH</span>(disbursement_date), 2, <span class="sql-string">'0'</span>)  <span class="code-comment">-- Creates 01, 02, not 1, 2</span></div>

            <h4>2. Empty Monthly Groups:</h4>
            <div class="code-block">-- Always filter for non-null dates
<span class="sql-keyword">WHERE</span> disbursement_date <span class="sql-keyword">IS NOT NULL</span></div>

            <h4>3. Percentage Division:</h4>
            <div class="code-block">-- Use 100.0 (decimal) for proper division
<span class="sql-function">COUNT</span>(defaults) * 100.0 / <span class="sql-function">COUNT</span>(total)</div>
        </div>
    </div>

    <div class="footer">
        <p><strong>STEP 5 Time-Based Crisis Analysis - EduFin Crisis Investigation</strong></p>
        <p>Your query successfully identifies September 2023 as the crisis peak with 19.15% default rate! üéØ</p>
        <p>Next: Executive Summary Query - "Complete board-ready crisis dashboard"</p>
    </div>
</body>
</html>